"use strict";
Component({
    options: {
        addGlobalClass: true,
        // 指定所有 _ 开头的数据字段为纯数据字段
        pureDataPattern: /^_/,
        multipleSlots: true // 在组件定义时的选项中启用多slot支持
    },
    properties: {
        vtabs: { type: Array, value: [] },
        tabBarClass: { type: String, value: '' },
        activeClass: { type: String, value: '' },
        tabLineColor: { type: String, value: '#ff0000' },
        tabInactiveTextColor: { type: String, value: '#000000' },
        tabActiveTextColor: { type: String, value: '#ff0000' },
        tabInactiveBgColor: { type: String, value: '#eeeeee' },
        tabActiveBgColor: { type: String, value: '#ffffff' },
        activeTab: { type: Number, value: 0 },
        animation: { type: Boolean, value: true },
        leftWidth: { type: Number, value: 110 },
    },
    data: {
        currentView: 0,
        contentScrollTop: 0,
        _heightRecords: [],
        _contentHeight: {},
        _contentTarget: []
    },
    observers: {
        activeTab(activeTab) {
            this.scrollTabBar(activeTab);
        }
    },
    relations: {
        '../vtabs-content/index': {
            type: 'child',
            linked(target) {
                // @ts-ignore
                this.data._contentTarget.push(target);
            },
            unlinked(target) {
                delete this.data._contentHeight[target.data.tabIndex];
            }
        }
    },
    lifetimes: {
        attached() {
        },
        ready() {
            this.calcChildrenHeight();
        }
    },
    methods: {
        calcChildrenHeight() {
            for (let index = 0; index < this.data._contentTarget.length; index++) {
                const target = this.data._contentTarget[index];
                if (target) {
                    // @ts-ignore
                    target.calcHeight((rect) => {
                        // @ts-ignore
                        this.data._contentHeight[target.data.tabIndex] = rect.height;
                        // @ts-ignore
                        if (this._calcHeightTimer) {
                            // @ts-ignore
                            clearTimeout(this._calcHeightTimer);
                        }
                        // @ts-ignore
                        this._calcHeightTimer = setTimeout(() => { this.calcHeight(); }, 100);
                    });
                }
            }
        },
        calcHeight() {
            const { length } = this.data.vtabs;
            const { _contentHeight } = this.data;
            const _heightRecords = [];
            let temp = 0;
            for (let i = 0; i < length; i++) {
                // @ts-ignore
                _heightRecords[i] = temp + (_contentHeight[i] || 0);
                temp = _heightRecords[i];
            }
            this.data._heightRecords = _heightRecords;
            // console.log('_heightRecords', _heightRecords)
        },
        scrollTabBar(index) {
            const len = this.data.vtabs.length;
            if (len === 0)
                return;
            let currentView = index < 6 ? 0 : index - 5;
            if (currentView >= len)
                currentView = len - 1;
            this.setData({ currentView });
        },
        handleTabClick(e) {
            const { _heightRecords } = this.data;
            const { index } = e.currentTarget.dataset;
            const contentScrollTop = _heightRecords[index - 1] || 0;
            this.triggerEvent('tabclick', { index });
            this.setData({
                activeTab: index,
                contentScrollTop
            });
        },
        handleContentScroll(e) {
            const { _heightRecords } = this.data;
            if (_heightRecords.length === 0)
                return;
            const { length } = this.data.vtabs;
            const { scrollTop } = e.detail;
            let index = 0;
            if (scrollTop >= _heightRecords[0]) {
                for (let i = 1; i < length; i++) {
                    if (scrollTop >= _heightRecords[i - 1] && scrollTop < _heightRecords[i]) {
                        index = i;
                        break;
                    }
                }
            }
            if (index !== this.data.activeTab) {
                this.triggerEvent('change', { index });
                this.setData({ activeTab: index });
            }
        }
    }
});
